# PilotProOS Development Nginx Configuration
# WEBHOOK PUBLIC ACCESS for external services (Microsoft Outlook, APIs)
# Supports both HTTP and HTTPS for universal compatibility

server {
    listen 80;
    server_name localhost _;
    
    # Development-friendly headers
    add_header X-Environment "Development-HTTP" always;
    add_header X-Service "PilotProOS Development" always;
    
    # Hide server information
    server_tokens off;
    
    # ========================================================================
    # SAME CONFIGURATION AS HTTPS (Universal compatibility)
    # ========================================================================
    
    # ========================================================================
    # PUBLIC ACCESS (Development + Webhook)
    # ========================================================================
    
    # Health check endpoint (MUST BE FIRST)
    location /health {
        proxy_pass http://pilotpros-backend-dev:3001/health;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        access_log off;
    }

    # Backend API - Business Operations (MUST BE FIRST - most specific)
    location /api/ {
        proxy_pass http://pilotpros-backend-dev:3001/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Frontend - Vue 3 Development Server (LAST - catch all)
    location / {
        proxy_pass http://pilotpros-frontend-dev:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket support for Vite HMR
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
    
    # ========================================================================
    # WEBHOOK PUBLIC ACCESS (CRITICAL for External Services)
    # ========================================================================
    
    # Webhook endpoint - PUBLIC ACCESS for Microsoft Outlook, APIs, etc.
    location /webhook/ {
        # Allow large payloads (email attachments, etc.)
        client_max_body_size 50M;
        
        # Proxy to n8n webhook endpoint
        proxy_pass http://pilotpros-automation-engine-dev:5678/webhook/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeout settings for long-running webhooks
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Development logging
        access_log /var/log/nginx/webhook-dev.log;
        error_log /var/log/nginx/webhook-dev-error.log debug;
        
        # CORS headers for development (if needed for API testing)
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
        
        # Handle preflight requests
        if ($request_method = 'OPTIONS') {
            return 204;
        }
    }
    
    # Alternative webhook path (for backward compatibility) - DISABLED FOR DEBUG
    # location /api/webhook/ {
    #     proxy_pass http://pilotpros-automation-engine-dev:5678/webhook/;
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    # }
    
    # OAuth callback endpoint - PUBLIC ACCESS for Microsoft Outlook authentication
    location /rest/ {
        # Proxy to n8n REST API for OAuth callbacks
        proxy_pass http://pilotpros-automation-engine-dev:5678/rest/;
        proxy_set_header Host "10.42.178.174";
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto http;
        proxy_set_header X-Forwarded-Host "10.42.178.174";
        proxy_set_header X-Forwarded-Port "80";
        
        # OAuth specific settings
        proxy_redirect http://pilotpros-automation-engine-dev:5678/ http://10.42.178.174/;
        proxy_redirect http://localhost:5678/ http://10.42.178.174/;
        
        # Access logging
        access_log /var/log/nginx/oauth-access.log;
    }
    
    # ========================================================================
    # DEVELOPMENT ACCESS (n8n Admin)
    # ========================================================================
    
    # n8n Admin Interface - DEVELOPMENT ACCESS
    location /dev/n8n/ {
        # Allow all in development
        proxy_pass http://pilotpros-automation-engine-dev:5678/;
        
        # CRITICAL: Force correct Host header for n8n URL calculation
        proxy_set_header Host "10.42.178.174";
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto http;
        proxy_set_header X-Forwarded-Host "10.42.178.174";
        proxy_set_header X-Forwarded-Port "80";
        
        # WebSocket support for n8n editor
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Development headers
        add_header X-Frame-Options SAMEORIGIN;
        add_header X-Development-Access "n8n Admin Interface" always;
    }
    
    # Database Admin (pgAdmin) - Development Access
    # location /dev/db/ {
    #     proxy_pass http://pilotpros-pgadmin-dev:80/;
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    # }
    
    
    # ========================================================================
    # HEALTH & MONITORING
    # ========================================================================
    
    # Health check endpoint (removed duplicate - see line 25)
    
    # System status (development)
    location /dev/status {
        default_type application/json;
        return 200 '{"status":"development","webhook_url":"http://$host/webhook/","n8n_admin":"http://$host/dev/n8n/","services":{"frontend":"http://pilotpros-frontend-dev:3000","backend":"http://pilotpros-backend-dev:3001","n8n":"http://pilotpros-automation-engine-dev:5678"}}';
    }
}

# HTTPS Server (Self-Signed for Development)
server {
    listen 443 ssl http2;
    server_name _;
    
    # SSL Configuration (Self-Signed)
    ssl_certificate /etc/ssl/pilotpros/pilotpros-dev.crt;
    ssl_certificate_key /etc/ssl/pilotpros/pilotpros-dev.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    
    # Development headers
    add_header X-Environment "Development-HTTPS" always;
    add_header X-Service "PilotProOS Development HTTPS" always;
    
    # Hide server information
    server_tokens off;
    
    # ========================================================================
    # SAME ENDPOINTS AS HTTP SERVER (Universal Access)
    # ========================================================================
    
    # Webhook endpoint - HTTPS PUBLIC ACCESS
    location /webhook/ {
        client_max_body_size 50M;
        
        proxy_pass http://pilotpros-automation-engine-dev:5678/webhook/;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $http_host;
        
        access_log /var/log/nginx/webhook-https-access.log;
    }
    
    # OAuth callback endpoint - HTTPS for Microsoft
    location /rest/ {
        proxy_pass http://pilotpros-automation-engine-dev:5678/rest/;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $http_host;
        
        # OAuth redirects for HTTPS
        proxy_redirect http://pilotpros-automation-engine-dev:5678/ https://$http_host/;
        proxy_redirect http://localhost:5678/ https://$http_host/;
        
        access_log /var/log/nginx/oauth-https-access.log;
    }
    
    # Frontend HTTPS
    location / {
        proxy_pass http://pilotpros-frontend-dev:3000;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        
        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
    
    # Backend API HTTPS
    location /api/ {
        proxy_pass http://pilotpros-backend-dev:3001/api/;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
    }
    
    # n8n Admin HTTPS
    location /dev/n8n/ {
        proxy_pass http://pilotpros-automation-engine-dev:5678/;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $http_host;
        
        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
    
    # Health check HTTPS (use HTTP server health endpoint)
}

# HTTPS Server end

# Default server for invalid requests
server {
    listen 80 default_server;
    server_name _;
    return 444;
}