# Common location blocks for both HTTP and HTTPS
# Included in nginx-universal.conf

# Webhook endpoint - PUBLIC ACCESS
location /webhook/ {
    client_max_body_size 50M;
    
    proxy_pass http://pilotpros-automation-engine-dev:5678/webhook/;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $http_host;
    
    access_log /var/log/nginx/webhook-access.log;
}

# OAuth callback endpoint - PUBLIC ACCESS for Microsoft
location /rest/ {
    proxy_pass http://pilotpros-automation-engine-dev:5678/rest/;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $http_host;
    
    # OAuth redirects
    proxy_redirect http://pilotpros-automation-engine-dev:5678/ $scheme://$http_host/;
    proxy_redirect http://localhost:5678/ $scheme://$http_host/;
    
    access_log /var/log/nginx/oauth-access.log;
}

# Frontend
location / {
    proxy_pass http://pilotpros-frontend-dev:3000;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # WebSocket support
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}

# Backend API
location /api/ {
    proxy_pass http://pilotpros-backend-dev:3001/api/;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# n8n Admin (development)
location /dev/n8n/ {
    proxy_pass http://pilotpros-automation-engine-dev:5678/;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $http_host;
    
    # WebSocket support
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}

# Health check
location /health {
    proxy_pass http://pilotpros-backend-dev:3001/health;
    access_log off;
}